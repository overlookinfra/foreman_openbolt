<%= form_with url: foreman_bolt.task_exec_path, local: true do |f| %>
  <div class="form-group">
    <label for="smart_proxy_id">Smart Proxy</label>
    <%= f.collection_select :smart_proxy_id, @smart_proxies, :id, :name,
          { prompt: 'Select Smart Proxy' },
          { id: 'proxy_select', class: 'form-control' } %>
  </div>

  <div class="form-group">
    <label for="task_select">Task Name</label>
    <div style="display: flex; gap: 0.5em; align-items: center;">
      <select id="task_select" name="task_name" class="form-control">
        <option value="">Select Task</option>
      </select>
      <button type="button" id="reload_tasks" class="btn btn-secondary" title="Reload tasks&#10;This will cause the proxy to reload all&#10;tasks from disk and will take some time.">
        &#x21bb;
      </button>
    </div>
  </div>

  <div class="form-group">
    <%= f.submit 'Run Task', class: 'btn btn-primary', id: 'run_task_btn', disabled: true %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var proxy     = document.getElementById('proxy_select'),
      task      = document.getElementById('task_select'),
      reloadBtn = document.getElementById('reload_tasks'),
      runBtn    = document.getElementById('run_task_btn'),
      tasksUrl  = '<%= foreman_bolt.get_tasks_path %>',
      reloadUrl = '<%= foreman_bolt.reload_tasks_path %>';
  var loading = false;

  function setLoading(val) {
    loading = val;
    runBtn.disabled = (!proxy.value || !task.value || loading);
    reloadBtn.disabled = (!proxy.value || loading);
  }

  function refreshTasks(force) {
    if (!proxy.value) {
      task.innerHTML = '<option value="">Choose a Smart Proxy first</option>';
      setLoading(false);
      return;
    }

    if (loading) return; // Prevent multiple concurrent fetches
    task.innerHTML = '<option value="">Loading...</option>';
    setLoading(true);

    var fetchUrl = force ? reloadUrl : tasksUrl;
    fetch(fetchUrl + '?proxy_id=' + encodeURIComponent(proxy.value), { credentials: 'same-origin' })
      .then(res => res.json().then(data => ({ status: res.status, data: data })))
      .then(({ status, data }) => {
        if (status !== 200 || data.error) {
          task.innerHTML = '<option value="">Error: ' + (data.error || 'Unable to load tasks') + '</option>';
        } else {
          task.innerHTML = data.length
            ? data.map(n => '<option value="'+n+'">'+n+'</option>').join('')
            : '<option value="">No tasks available</option>';
        }
        setLoading(false);
      })
      .catch(function(){
        task.innerHTML = '<option value="">Error loading tasks</option>';
        setLoading(false);
      });
  }

  proxy.addEventListener('change', function() { refreshTasks(false); });
  reloadBtn.addEventListener('click', function()  { refreshTasks(true); });
  refreshTasks(false);
});
</script>
