<%= form_with url: foreman_bolt.task_exec_path, local: true do |f| %>
  <div class="form-group">
    <label for="smart_proxy_id">Smart Proxy</label>
    <%= f.collection_select :smart_proxy_id, @smart_proxies, :id, :name,
          { prompt: 'Select Smart Proxy' },
          { id: 'proxy_select', class: 'form-control' } %>
  </div>

  <div class="form-group">
    <label for="task_select">Task Name</label>
    <div style="display: flex; gap: 0.5em; align-items: center;">
      <select id="task_select" name="task_name" class="form-control">
        <option value="">Select Task</option>
      </select>
      <button type="button" id="reload_tasks" class="btn btn-secondary" title="Reload tasks&#10;This will cause the proxy to reload all&#10;tasks from disk and will take some time.">
        &#x21bb;
      </button>
    </div>
  </div>

  <div class="form-group" style="margin-top:1em; margin-bottom:1em;">
    <label>Parameters</label>
    <div id="task_params" style="border:1px solid #ccc; border-radius:4px; padding:1em; min-height:2em;"></div>
  </div>

  <div class="form-group" style="margin-top:1em; margin-bottom:1em;">
    <label>Bolt Options</label>
    <div id="bolt_options" style="border:1px solid #ccc; border-radius:4px; padding:1em; min-height:2em;"></div>
  </div>

  <div class="form-group" style="margin-top:1em; margin-bottom:1em;">
    <%= f.submit 'Run Task', class: 'btn btn-primary', id: 'run_task_btn', disabled: true %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var proxy          = document.getElementById('proxy_select'),
      task           = document.getElementById('task_select'),
      reloadBtn      = document.getElementById('reload_tasks'),
      runBtn         = document.getElementById('run_task_btn'),
      paramsDiv      = document.getElementById('task_params'),
      boltOptionsDiv = document.getElementById('bolt_options'),
      tasksUrl       = '<%= foreman_bolt.get_tasks_path %>',
      reloadUrl      = '<%= foreman_bolt.reload_tasks_path %>',
      boltOptionsUrl = '<%= foreman_bolt.get_bolt_options_path %>';
  var loadingTasks = false;
  var loadingOptions = false;
  var taskMetadata = {};

  function setLoading() {
    runBtn.disabled = (!proxy.value || !task.value || loadingTasks || loadingOptions);
    reloadBtn.disabled = (!proxy.value || loadingTasks);
    if (runBtn.disabled) paramsDiv.innerHTML = '';
  }

  function createLabel(name, isOptional, displayType, prefix) {
    var label = document.createElement('label');
    label.style.marginBottom = '0.25em';
    label.htmlFor = prefix + '_' + name;
    label.innerHTML =
      name +
      (isOptional ? '' : ' <span style="color:red">*</span>') +
      (displayType ? '<span style="color:#888; font-size:90%; padding:0.5em;">' + displayType + '</span>' : '');
    return label;
  }

  function createInput(name, metadata, isOptional, prefix) {
    var input;
    var type = Array.isArray(metadata.type) ? 'enum' : (metadata.type || '').toLowerCase();
    if (type === 'enum') {
      input = document.createElement('select');
      input.className = 'form-control';
      metadata.type.forEach(function(opt){
        var option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        input.appendChild(option);
      });
      input.value = metadata.default || metadata.type[0] || '';
    } else if (type === 'boolean') {
      input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = metadata.default || false;
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control';
      input.value = metadata.default || '';
    }
    input.name = prefix + '[' + name + ']';
    input.id = prefix + '_' + name;
    input.required = !isOptional;
    return input;
  }

  function createDescription(description) {
    var desc = document.createElement('small');
    desc.className = 'form-text text-muted';
    desc.textContent = description;
    desc.style.display = 'block';
    desc.style.marginTop = '0.25em';
    return desc;
  }

  function renderParams() {
    paramsDiv.innerHTML = '';
    noParams = '<span style="color:#888;">No parameters for this task.</span>';
    var selected = task.value;
    var params = (selected && taskMetadata[selected] && taskMetadata[selected].parameters) || null;
    if (!params || Object.keys(params).length === 0) {
      paramsDiv.innerHTML = noParams;
      return;
    }
    Object.entries(params).forEach(function([name, metadata]) {
      var isOptional = metadata.type && metadata.type.startsWith('Optional')
      var group = document.createElement('div');
      group.className = 'form-group';
      group.style.marginBottom = '1em';

       var label = createLabel(name, isOptional, metadata.type || 'Unknown Type');
      var input = createInput(name, metadata, isOptional);
      if (metadata.type === 'Boolean') {
        var flexRow = document.createElement('div');
        flexRow.style.display = 'flex';
        flexRow.style.alignItems = 'center';
        flexRow.style.gap = '0.5em';
        flexRow.appendChild(label);
        flexRow.appendChild(input);
        group.appendChild(flexRow);
      } else {
        // Text: label above input
        group.appendChild(label);
        group.appendChild(input);
      }
      if (metadata.description) group.appendChild(createDescription(metadata.description));
      paramsDiv.appendChild(group);
    });
  }

  function renderBoltOptions(data) {
    boltOptionsDiv.innerHTML = '';
    if (!data || Object.keys(data).length === 0) {
      boltOptionsDiv.innerHTML = '<span style="color:#888;">No Bolt options available. This is unexpected. Check that the Smart Proxy is running correctly.</span>';
      return;
    }
    Object.entries(data).forEach(function([name, metadata]) {
      var type = metadata.type || 'string';
      var isOptional = name !== 'transport';

      var group = document.createElement('div');
      group.className = 'form-group';
      group.style.marginBottom = '1em';

      var label = createLabel(name, isOptional, null, 'option');
      var input = createInput(name, metadata, isOptional, 'option');
      if (metadata.type === 'boolean') {
        var flexRow = document.createElement('div');
        flexRow.style.display = 'flex';
        flexRow.style.alignItems = 'center';
        flexRow.style.gap = '0.5em';
        flexRow.appendChild(label);
        flexRow.appendChild(input);
        group.appendChild(flexRow);
      } else {
        // Text: label above input
        group.appendChild(label);
        group.appendChild(input);
      }
      // Don't currently have descriptions here, but we should
      if (metadata.description) group.appendChild(createDescription(metadata.description));
      boltOptionsDiv.appendChild(group);
    });
  }

  function fetchBoltOptions() {
    if (!proxy.value) {
      boltOptions.innerHTML = '<option value="">Choose a Smart Proxy</option>';
      loadingOptions = false;
      setLoading();
      return;
    }

    if (loadingOptions) return; // Prevent multiple concurrent fetches
    boltOptionsDiv.innerHTML = '<span style="color:#888;">Loading...</span>';
    loadingOptions = true;
    setLoading();

    fetch(boltOptionsUrl + '?proxy_id=' + encodeURIComponent(proxy.value), { credentials: 'same-origin' })
      .then(res => res.json().then(data => ({ status: res.status, data: data })))
      .then(function({ status, data }) {
        if (status !== 200 || data.error) {
          boltOptionsDiv.innerHTML = '<span style="color:red;">Error loading Bolt options</span>';
        } else {
          renderBoltOptions(data);
        }
        loadingOptions = false;
        setLoading();
      })
      .catch(function() {
        boltOptionsDiv.innerHTML = '<span style="color:red;">Failed to load Bolt options.</span>';
        loadingOptions = false;
        setLoading();
      });
  }

  function refreshTasks(force) {
    if (!proxy.value) {
      task.innerHTML = '<option value="">Choose a Smart Proxy</option>';
      loadingTasks = false;
      setLoading();
      taskMetadata = {};
      return;
    }

    if (loadingTasks) return; // Prevent multiple concurrent fetches
    task.innerHTML = '<option value="">Loading...</option>';
    loadingTasks = true;
    setLoading();

    var fetchUrl = force ? reloadUrl : tasksUrl;
    fetch(fetchUrl + '?proxy_id=' + encodeURIComponent(proxy.value), { credentials: 'same-origin' })
      .then(res => res.json().then(data => ({ status: res.status, data: data })))
      .then(({ status, data }) => {
        if (status !== 200 || data.error) {
          task.innerHTML = '<option value="">Error: ' + (data.error || 'Unable to load tasks') + '</option>';
          taskMetadata = {};
        } else {
          taskMetadata = data;
          var names = Object.keys(data);
          task.innerHTML = names.length
            ? names.map(n => '<option value="'+n+'">'+n+'</option>').join('')
            : '<option value="">No tasks available</option>';
        }
        paramsDiv.innerHTML = ''; // Clear previous parameters
        if (names.length) {
          task.value = names[0]; // Select first task by default
          renderParams(); // Render parameters for the first task
        }
        loadingTasks = false;
        setLoading();
      })
      .catch(function(){
        task.innerHTML = '<option value="">Error loading tasks</option>';
        loadingTasks = false;
        setLoading();
        taskMetadata = {};
        paramsDiv.innerHTML = '';
      });
  }

  proxy.addEventListener('change', function() { 
    fetchBoltOptions();
    refreshTasks(false); 
  });
  reloadBtn.addEventListener('click', function()  { refreshTasks(true); });
  task.addEventListener('change', function () { renderParams(); });
  if (proxy.value) fetchBoltOptions();
  refreshTasks(false);
});
</script>
