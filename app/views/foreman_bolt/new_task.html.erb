<%= title _('Run Bolt Task') %>

<style>
  #task_params, #bolt_options {
    padding-top: 10px !important;
    padding-bottom: 30px !important;
    padding-left: 30px !important;
    padding-right: 30px !important;
    min-height: 150px !important;
    max-height: 400px !important;
    overflow-y: auto !important;
    overflow-x: hidden !important;
  }
  .blank-slate-pf {
    margin-top: 20px !important;
    padding-bottom: 10px !important;
    border: none !important;
    text-align: center !important;
  }
  .blank-slate-pf-icon { padding-top: 10px !important; }
  .help-inline.text-muted { 
    margin-left: 0.5em !important;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: bottom;
    cursor: help;
  }
  .required-input { color: #cc0000 !important; margin-left: 3px; }

  /* High contrast for accessibility */
  .form-control:focus, .btn:focus {
    outline: 2px solid #005fcc;
    outline-offset: 2px;
  }
</style>

<%= form_with url: foreman_bolt.task_exec_path, local: true, class: 'form-horizontal', html: { role: 'form' } do |f| %>
  <div class="form-group">
    <label for="proxy_id" class="col-md-2 control-label"><%= _('Smart Proxy') %></label>
    <div class="col-md-6">
      <%= f.collection_select :proxy_id, @smart_proxies, :id, :name,
            { prompt: _('Select Smart Proxy') },
            { id: 'proxy_select', class: 'form-control', data: { 'proxy-url': foreman_bolt.fetch_bolt_options_path }, 'aria-required': 'true' } %>
    </div>
  </div>
  <div class="form-group">
    <label for="targets" class="col-md-2 control-label"><%= _('Targets') %></label>
    <div class="col-md-6">
      <input type="text" id="targets" name="targets" class="form-control"
             required aria-required="true" aria-describedby="targets-help">
      <span id="targets-help" class="help-block"><%= _('Comma-separated list of targets (e.g., host1,host2,host3)') %></span>
    </div>
  </div>
  <div class="form-group">
    <label for="task_select" class="col-md-2 control-label"><%= _('Task Name') %></label>
    <div class="col-md-6" style="display: flex; gap: 0.5rem; align-items: center;">
      <select id="task_select" name="task_name" class="form-control" disabled aria-required="true">
        <option value=""><%= _('Select Task') %></option>
      </select>
      <button type="button" id="reload_tasks" class="btn btn-default" disabled
              title="<%= _('Reload tasks from Bolt. This may take some time.') %>"
              aria-label="<%= _('Reload tasks from Bolt. This may take some time.') %>">
        <span class="pficon pficon-restart" aria-hidden="true"></span>
      </button>
    </div>
  </div>
  <div class="form-group">
    <label class="col-md-2 control-label"><%= _('Parameters') %></label>
    <div class="col-md-8">
      <div id="task_params" class="well" role="region" aria-label="<%= _('Task Parameters') %>" aria-live="polite" aria-busy="false">
        <div class="blank-slate-pf" role="status">
          <div class="blank-slate-pf-icon"><span class="pficon pficon-info" aria-hidden="true"></span></div>
          <h4><%= _('Select a task to see parameters') %></h4>
        </div>
      </div>
    </div>
  </div>
  <div class="form-group">
    <label class="col-md-2 control-label"><%= _('Bolt Options') %></label>
    <div class="col-md-8">
      <div id="bolt_options" class="well" role="region" aria-label="<%= _('Bolt Options') %>" aria-live="polite" aria-busy="false">
        <div class="blank-slate-pf" role="status">
          <div class="blank-slate-pf-icon"><span class="pficon pficon-settings" aria-hidden="true"></span></div>
          <h4><%= _('Select a Smart Proxy to see Bolt options') %></h4>
        </div>
      </div>
    </div>
  </div>
  <div class="form-group">
    <div class="col-md-offset-2 col-md-6">
      <%= f.submit _('Run Task'), class: 'btn btn-primary', id: 'run_task_btn', disabled: true %>
    </div>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const proxySel    = document.getElementById('proxy_select'),
        taskSel     = document.getElementById('task_select'),
        reloadBtn   = document.getElementById('reload_tasks'),
        runBtn      = document.getElementById('run_task_btn'),
        paramsDiv   = document.getElementById('task_params'),
        optsDiv     = document.getElementById('bolt_options');

  const URLS = {
    tasks:  '<%= foreman_bolt.fetch_tasks_path %>',
    reload: '<%= foreman_bolt.reload_tasks_path %>',
    opts:   '<%= foreman_bolt.fetch_bolt_options_path %>'
  };

  let loading = { tasks: false, opts: false },
      taskMeta = {};

  /**
   * Displays a notification message. Falls back to other methods
   * if we don't have access to tfm for some reason.
   * 
   * @param {string} msg  - The message to display.
   * @param {string} type - The type of notification (e.g., 'error', 'info').
   */
  function notify(msg, type = 'error') {
    if (tfm?.toastNotifications?.notify) {
      tfm.toastNotifications.notify({ message: msg, type });
    } else if (typeof notify === 'function') {
      window.notify(msg, type);
    } else {
      console[type === 'error' ? 'error' : 'log'](msg);
    }
  }

  /**
   * Fetches JSON data from a given URL and handles errors.
   * @param {string} url        - The URL to fetch data from.
   * @param {function} callback - The callback function to handle the response.
   */
  function fetchJson(url, callback) {
    fetch(url, {
      credentials: 'same-origin',
      // Not entirely necessary, but for correctness, this says we are loading
      // in an AJAX-y way and should always return JSON.
      headers: { 'Accept':'application/json','X-Requested-With':'XMLHttpRequest' }
    })
    .then(r => r.json())
    .then(data => data.error ? (notify(data.error), callback(null)) : callback(data))
    .catch(e => (notify(e.message), callback(null)));
  }

  /**
   * Enable/disable buttons & dropdown based on if we're loading
   * and the right things have selections made.
   */
  function updateComponentStates() {
    runBtn.disabled    = !proxySel.value || !taskSel.value || loading.tasks || loading.opts;
    reloadBtn.disabled = !proxySel.value || loading.tasks;
    taskSel.disabled   = !proxySel.value || loading.tasks;
  }

  /**
   * Creates an input element for a form field.
   * @param {string} name      - The field name.
   * @param {Object} meta      - The metadata for the field. Must contain `type`, and 
   *                             optionally `default` and `description`. Any type that is
   *                             not an array or boolean will be treated as a string (for now).
   * @param {string} prefix    - The prefix for the field's ID and name.
   * @returns {HTMLElement}    - The created input element.
   */
  function createInput(name, meta, prefix) {
    let input;
    const type = Array.isArray(meta.type) ? 'enum' : (meta.type || '').toLowerCase();
    const required = prefix !== 'options' && !type.startsWith('optional[');
    if (type === 'enum') {
      input = document.createElement('select');
      input.className = 'form-control';
      meta.type.forEach(v => input.append(new Option(v, v)));
      input.value = meta.default || (input.options[0] && input.options[0].value) || '';
      input.required = required;
    } else if (type === 'boolean' || type == 'optional[boolean]') {
      input = document.createElement('input');
      input.type = 'checkbox';
      input.checked = !!meta.default;
      // Never set required for checkboxes
    } else {
      input = document.createElement('input');
      input.type = 'text';
      input.className = 'form-control';
      input.value = meta.default || '';
      input.required = required;
    }
    input.id       = `${prefix}_${name}`;
    input.name     = `${prefix}[${name}]`;
    if (input.required) input.setAttribute('aria-required', 'true');
    return input;
  }

  /**
   * Creates a form group for a field, including its label and input.
   * 
   * @param {string} name        - The field name.
   * @param {Object} meta        - The metadata for the field.
   * @param {string} prefix      - The prefix for the field's ID and name.
   * @param {boolean} showType   - Whether to show the field type.
   * @returns {HTMLElement}      - The created form group element.
   */
  function createGroup(name, meta, prefix, showType = true) {
    const group = document.createElement('div');
    const typeString = String(meta.type || '').toLowerCase();
    const isBoolean = typeString === 'boolean' || typeString === 'optional[boolean]';
    const required = prefix !== 'options' && !typeString.startsWith('optional[');
    group.classList.add('form-group');

    const label = document.createElement('label');
    label.className = 'control-label';
    label.htmlFor = `${prefix}_${name}`;
    label.textContent = name;

    if (required) {
      const star = document.createElement('span');
      star.className = 'required-input';
      star.textContent = '*';
      star.setAttribute('aria-hidden', 'true');
      label.appendChild(star);
    }

    if (showType && !isBoolean && meta.type) {
      const typeText = Array.isArray(meta.type) ? String(meta.type) : meta.type;
      const typeBadge = document.createElement('span');
      typeBadge.className = 'help-inline text-muted';
      typeBadge.textContent = typeText;
      typeBadge.title = typeText;
      typeBadge.setAttribute('aria-label', typeText);
      label.appendChild(typeBadge);
    }

    const input = createInput(name, meta, prefix);

    // If there's a description, link it for screen readers
    let help;
    if (meta.description) {
      help = document.createElement('span');
      help.className = 'help-block';
      help.textContent = meta.description;
      const helpId = `${prefix}_${name}_help`;
      help.id = helpId;
      input.setAttribute('aria-describedby', helpId);
    }

    group.append(label, input);
    if (help) group.appendChild(help);

    return group;
  }

  /**
   * Renders a set of fields into a container element.
   * 
   * @param {Object} data           - The data object containing field metadata.
   * @param {HTMLElement} container - The container element to render fields into.
   * @param {string} prefix         - The prefix for the field's ID and name.
   * @param {boolean} showType      - Whether to show the field type.
   */
  function renderFields(data, container, prefix, showType = true) {
    container.removeAttribute('aria-busy');
    container.innerHTML = '';
    if (!data || !Object.keys(data).length) {
      container.innerHTML = `
        <div class="blank-slate-pf" role="status" aria-live="polite">
          <div class="blank-slate-pf-icon">
            <span class="pficon pficon-info" aria-hidden="true"></span>
          </div>
          <h4>No ${prefix} available</h4>
        </div>`;
      return;
    }
    Object.entries(data).forEach(([name, metadata]) => {
      container.appendChild(
        createGroup(name, metadata, prefix, showType)
      );
    });
  }

  /**
   * Loads Bolt options for the selected Smart Proxy.
   * If no proxy is selected, it shows a message prompting the user to select one.
   */
  function loadOptions() {
    if (!proxySel.value) {
      optsDiv.innerHTML = `
        <div class="blank-slate-pf" role="status" aria-live="polite">
          <div class="blank-slate-pf-icon">
            <span class="pficon pficon-settings" aria-hidden="true"></span>
          </div>
          <h4><%= _('Select a Smart Proxy to see Bolt options') %></h4>
        </div>`;
      return;
    }
    loading.opts = true; updateComponentStates();
    showSpinner(optsDiv, '<%= _('Loading Bolt options...') %>');
    fetchJson(`${URLS.opts}?proxy_id=${encodeURIComponent(proxySel.value)}`, data => {
      loading.opts = false;
      if (data) renderFields(data, optsDiv, 'options', false);
      updateComponentStates();
    });
  }

  /**
   * Loads tasks for the selected Smart Proxy.
   * If no proxy is selected, it shows a message prompting the user to select one.
   * If tasks are already loading, it does nothing.
   * If `force` is true, it reloads the tasks from the server.
   */
  function loadTasks(force = false) {
    if (!proxySel.value) {
      taskSel.innerHTML = '<option><%= _('Select a Smart Proxy first') %></option>';
      paramsDiv.innerHTML = `<div class="blank-slate-pf" role="status" aria-live="polite">
        <div class="blank-slate-pf-icon">
          <span class="pficon pficon-info" aria-hidden="true"></span>
        </div>
        <h4><%= _('Select a Smart Proxy and task to see parameters') %></h4>
      </div>`;
      taskMeta = {}; taskSel.disabled = true; return;
    }
    if (loading.tasks) return;
    loading.tasks = true; updateComponentStates();
    taskSel.innerHTML = '<option><%= _('Loading tasks...') %></option>';
    fetchJson(
      `${force ? URLS.reload : URLS.tasks}?proxy_id=${encodeURIComponent(proxySel.value)}`,
      data => {
        loading.tasks = false;
        taskMeta = data || {};
        if (data) {
          const keys = Object.keys(data);
          if (!keys.length) {
            taskSel.innerHTML = '<option><%= _('No tasks available') %></option>';
          } else {
            taskSel.innerHTML = '<option><%= _('Select a task') %></option>'
              + keys.map(k => `<option value="${k}">${k}</option>`).join('');
            taskSel.value = keys[0];
            renderParams();
          }
        }
        updateComponentStates();
      }
    );
  }

  /**
   * Renders the parameters for the selected task.
   * If no task is selected, it shows a message prompting the user to select one.
   */
  function renderParams() {
    showSpinner(paramsDiv, '<%= _('Loading task parameters...') %>');
    // Using setTimeout to ensure the spinner shows up before we render fields
    // and we don't get any weird race conditions.
    setTimeout(() => {
      const taskName = taskSel.value,
            params   = taskMeta[taskName]?.parameters;
      renderFields(params, paramsDiv, 'params');
    }, 0);
  }

  function showSpinner(container, message) {
    container.setAttribute('aria-busy', 'true');
    container.innerHTML = `
        <div class="spinner-container" role="status" aria-live="polite">
          <div class="spinner spinner-lg" aria-hidden="true"></div>
          <p class="text-center">${message}</p>
        </div>
      `;
  }

  // Event wiring
  proxySel.onchange  = () => { loadOptions(); loadTasks(false); };
  reloadBtn.onclick  = () => loadTasks(true);
  taskSel.onchange   = () => { renderParams(); updateComponentStates(); };

  // Initial load 
  if (proxySel.value) { loadOptions(); loadTasks(false); }
  updateComponentStates();
});
</script>
